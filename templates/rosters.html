{% extends "base.html" %}

{% block title %}Rosters{% endblock %}

{% block content %}

  <style>
      .topbar {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;   /* centers the Home button */
      gap: 12px;
      padding: 10px 16px;
      background: linear-gradient(to bottom, rgba(15,18,33,0.9), rgba(15,18,33,0.6));
      backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .homebtn {
      display: inline-block;
      text-decoration: none;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(255,213,74,0.12);
      color: var(--accent, #ffd54a);
      font-weight: 700;
      box-shadow: 0 0 0 1px rgba(255,213,74,0.25);
    }
    .homebtn:hover {
      box-shadow: 0 0 0 2px rgba(255,213,74,0.35);
    }

    .wrap { max-width: 1200px; margin: 24px auto; padding: 0 16px; }
    .controls { display:flex; gap:12px; align-items:center; justify-content:center; margin-bottom:16px; }
    select, button { padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#171a2c; color:#fff; }
    table { width:100%; border-collapse:collapse; background:#171a2c; border-radius:14px; overflow:hidden; }
    th, td { padding:10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; }
    th { color:#aab2d5; font-weight:600; }
    .pager { margin-top:12px; display:flex; justify-content:center; gap:8px; }
    .chip { display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,213,74,.12); color:#ffd54a; font-weight:700; }

    .playercell{display:flex;align-items:center;gap:8px}
    .playercell .logo{width:22px;height:22px;object-fit:contain}
    .playercell .number{font-weight:700;min-width:2.2ch;opacity:.9}
    .playercell .name{white-space:nowrap}

    .team-logo {
      height: 24px;
      width: auto;
      display: block;
    }


  </style>
  <style>
    .team-meta .badge{
      display:inline-block; padding:2px 8px; border-radius:999px;
      background:rgba(255,213,74,.12); color:#ffd54a; font-weight:700;
      margin-right:6px;
    }
    .team-meta .dim{opacity:.7}
  </style>
  <style>
    .searchwrap { display:flex; justify-content:center; margin:10px 0 14px; }
    .searchwrap input[type="text"]{
      width: min(560px, 90%);
      padding: 10px 12px; border-radius: 12px;
      border:1px solid rgba(255,255,255,.15); background:#171a2c; color:#fff;
      outline: none;
    }
    .row-hit { outline: 2px solid rgba(255,213,74,.45); outline-offset: -2px; }
  </style>
  <style>
    .team-head{
      display:grid;
      grid-template-columns: 1fr auto 1fr; /* left | center | right spacer */
      align-items:baseline;
      gap:12px;
    }
    .team-head h2{
      grid-column:1; justify-self:start; margin:0;
      min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .team-meta{
      grid-column:2; justify-self:center;
      display:flex; align-items:center; gap:10px; color:#cfe1ff;
    }
    .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,Consolas,Menlo,monospace}
    .sep{opacity:.6}
    @media (max-width:700px){
      .team-head{grid-template-columns:1fr; grid-auto-rows:auto}
      .team-meta{grid-column:1; justify-self:center; margin-top:6px}
    }
    .injury-badge {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      margin-left: .5rem;
      font-size: .8rem;
    }

    .injury-icon {
      width: 16px;
      height: 16px;
      cursor: help; /* indicates tooltip available */
    }

    .injury-weeks {
      font-size: .75rem;
      color: #e6bebe;
    }

  </style>

<div class="wrap">
  <h2>üèà Rosters</h2>

  <form class="controls" method="get" action="{{ url_for('rosters') }}">
    <input type="hidden" name="league" value="{{ league }}">
    <!-- Dropdown 1: NFL / Team -->
    <label>Team:
      <select name="team" onchange="this.form.submit()">
        {% for t in teams %}
          <option value="{{ t.id }}" {% if team == t.id %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
    </label>

    <!-- Dropdown 2: Roster / Position -->
    <label>View:
      <select name="pos" onchange="this.form.submit()">
        {% for p in positions %}
          <option value="{{ p }}" {% if pos == p %}selected{% endif %}>{{ 'Overall' if p=='ALL' else p }}</option>
        {% endfor %}
      </select>
    </label>

    <!-- Optional page size -->
    <label>Per page:
      <select name="per" onchange="this.form.submit()">
        {% for n in [25,50,100,200] %}
          <option value="{{ n }}" {% if per == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </label>
  </form>

  {% if show_search %}
    <div class="searchwrap">
      <input id="playerSearch" type="text"
             placeholder="Search players‚Ä¶ (type to filter)"
             list="playerNames" autocomplete="off">
      <datalist id="playerNames">
        {% for p in search_index %}
          <option value="{{ p.name }}"></option>
        {% endfor %}
      </datalist>
    </div>
  {% endif %}

  {% if team_total_count is not none %}
    <div class="team-head">
      <h2 style="margin:0">{{ team_name }}</h2>
      <div class="team-meta">
        <span class="mono">{{ team_total_count }}</span> players
        <span class="sep">‚Ä¢</span>
        Team OVR <b class="mono">{{ team_ovr or "‚Äî" }}</b>
      </div>
    </div>

  {% endif %}

  {% if show_sections %}
  <!-- Overall -->
  <h3 style="margin-top:16px;">Overall</h3>
  <table id="overallTable">
    <thead>
      <tr>
        {% for c in columns %}<th>{{ column_labels.get(c, c|upper) }}</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for p in overall_players %}
        <tr>
          {% for c in columns %}
            {% set v = p.get(c) %}
            <td>
            {% set is_name_col = c in ('name','playerName','player','displayName','fullName') or loop.first %}
            {% if is_name_col %}
              {% set jn = jersey_num(p) %}
              <div class="playercell overall">
                {% if p.teamId is not none %}
                  <img class="logo" src="{{ team_logo(p.teamId) }}" alt="">
                {% endif %}
                {% if jn %}<span class="number">#{{ jn }}</span>{% endif %}
                <span class="name">{{ p.playerName or p.name }}</span>
                {% if p.isInjured %}
                    {% if p.injuryType !=97 %} <!-- *** FIX THIS WHEN YOU FIND OUT WHAT 97 IS -->
                      <span class="injury-badge">
                        <img src="{{ url_for('static', filename='icons/injury.png') }}"
                             alt="Injured"
                             class="injury-icon"
                             title="{{ injury_name(p.injuryType) }}">
                        <span class="injury-weeks">{{ 'Wk' if p.injuryLength == 1 else 'Wks' }} {{ p.injuryLength }}</span>
                      </span>
                    {% endif %}
                {% endif %}
              </div>
            {% elif c == 'ovr' and v is not none %}
              <span class="chip">{{ v }}</span>
            {% else %}
              {{ v if v is not none else '' }}
            {% endif %}
          </td>
          {% endfor %}
        </tr>
      {% endfor %}
      {% if overall_players|length == 0 %}
        <tr><td colspan="{{ columns|length }}">No players in Overall.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <!-- Free Agents -->
  <h3 style="margin-top:28px;">Free Agents</h3>
  <table>
    <thead>
      <tr>
        {% for c in columns %}<th>{{ column_labels.get(c, c|upper) }}</th>{% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for p in free_agents %}
        <tr>
          {% for c in columns %}
            {% set v = p.get(c) %}
            <td>
              {% set is_name_col = c in ('name','playerName','player','displayName','fullName') or loop.first %}
              {% if is_name_col %}
                <div class="playercell team">
                  <span class="number">#{{ jersey_num(p) }}</span>
                  <span class="name">{{ p.playerName or p.name }}</span>
                </div>
              {% elif c == 'ovr' and v is not none %}
                <span class="chip">{{ v }}</span>
              {% else %}
                {{ v if v is not none else '' }}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
      {% if free_agents|length == 0 %}
        <tr><td colspan="{{ columns|length }}">No free agents found.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <!-- Teams -->
  <h3 style="margin-top:28px;">Teams</h3>
  {% for t in teams_block %}
    <h4 style="margin:14px 0 6px 0;">{{ t.teamName }}</h4>
    <table>
      <thead>
        <tr>
          {% for c in columns %}<th>{{ column_labels.get(c, c|upper) }}</th>{% endfor %}
        </tr>
      </thead>
      <tbody>
        {% for p in t.players %}
          <tr>
            {% for c in columns %}
              {% set v = p.get(c) %}
              <td>
              {% set is_name_col = c in ('name','playerName','player','displayName','fullName') or loop.first %}
              {% if is_name_col %}
                {% set jn = jersey_num(p) %}
                <div class="playercell team">
                  {% if jn %}<span class="number">#{{ jn }}</span>{% endif %}
                  <span class="name">{{ p.playerName or p.name }}</span>
                  {% if p.isInjured %}
                    {% if p.injuryType !=97 %} <!-- *** FIX THIS WHEN YOU FIND OUT WHAT 97 IS -->
                      <span class="injury-badge">
                        <img src="{{ url_for('static', filename='icons/injury.png') }}"
                             alt="Injured"
                             class="injury-icon"
                             title="{{ injury_name(p.injuryType) }}">
                        <span class="injury-weeks">{{ 'Wk' if p.injuryLength == 1 else 'Wks' }} {{ p.injuryLength }}</span>
                      </span>
                    {% endif %}
                  {% endif %}
                </div>
              {% elif c == 'ovr' and v is not none %}
                <span class="chip">{{ v }}</span>
              {% else %}
                {{ v if v is not none else '' }}
              {% endif %}
            </td>
            {% endfor %}
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endfor %}

{% else %}
  {% set show_team_logos = (team|string == 'NFL') %}
  <!-- Your existing single-table view for filtered pages -->
  <table>
    <thead>
      <tr>
        {% for c in columns %}
          <th>{{ column_labels.get(c, c|upper) }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for p in players %}
        <tr>
          {% for c in columns %}
            {% set v = p.get(c) %}
            <td>
              {% set is_name_col = c in ('name','playerName','player','displayName','fullName') or loop.first %}
              {% if is_name_col %}
                <div class="playercell {{ 'overall' if show_team_logos else 'team' }}">
                  {% if show_team_logos and p.teamId is not none %}
                    <img class="logo" src="{{ team_logo(p.teamId) }}" alt="">
                  {% endif %}
                  <span class="number">#{{ jersey_num(p) }}</span>
                  <span class="name">{{ p.playerName or p.name }}</span>
                  {% if p.isInjured %}
                    {% if p.injuryType !=97 %} <!-- *** FIX THIS WHEN YOU FIND OUT WHAT 97 IS -->
                      <span class="injury-badge">
                        <img src="{{ url_for('static', filename='icons/injury.png') }}"
                             alt="Injured"
                             class="injury-icon"
                             title="{{ injury_name(p.injuryType) }}">
                        <span class="injury-weeks">{{ 'Wk' if p.injuryLength == 1 else 'Wks' }} {{ p.injuryLength }}</span>
                      </span>
                    {% endif %}
                  {% endif %}
                </div>
              {% elif c == 'ovr' and v is not none %}
                <span class="chip">{{ v }}</span>
              {% else %}
                {{ v if v is not none else '' }}
              {% endif %}
            </td>
          {% endfor %}
        </tr>
      {% endfor %}
      {% if players|length == 0 %}
        <tr><td colspan="{{ columns|length }}">No players found for this filter.</td></tr>
      {% endif %}
    </tbody>
  </table>
{% endif %}


  {% if not show_sections %}
  <div class="pager">
    {% set total_pages = (total + per - 1) // per %}
    {% if page > 1 %}
      <a href="{{ url_for('rosters', league=league, team=team, pos=pos, per=per, page=page-1) }}">‚¨Ö Prev</a>
    {% endif %}
    <span>Page {{ page }} / {{ total_pages }}</span>
    {% if page < total_pages %}
      <a href="{{ url_for('rosters', league=league, team=team, pos=pos, per=per, page=page+1) }}">Next ‚û°</a>
    {% endif %}
  </div>
  {% endif %}

</div>
{% if show_search %}
<script>
(function(){
  const input = document.getElementById('playerSearch');
  if (!input) return;

  // Grab ALL roster rows on the page (Overall + Free Agents + every Team block)
  const allRows = Array.from(document.querySelectorAll('table tbody tr'));

  function norm(s){ return (s || '').toLowerCase().trim(); }

  function rowName(tr){
    const nameEl = tr.querySelector('.playercell .name');
    return norm(nameEl ? nameEl.textContent : '');
  }

  input.addEventListener('input', () => {
    const q = norm(input.value);
    let anyShown = false;

    // Show/hide rows based on match
    allRows.forEach(tr => {
      const name = rowName(tr);
      const match = !q || name.includes(q);
      tr.style.display = match ? '' : 'none';
      tr.classList.toggle('row-hit', match && q.length >= 2);
      if (match) anyShown = true;
    });

    // Optionally hide team tables that have no visible rows
    document.querySelectorAll('table').forEach(tbl => {
      const visibleRows = tbl.querySelectorAll('tbody tr:not([style*="display: none"])').length;
      // keep headers; only hide table if it has a body and zero visible rows
      if (tbl.querySelector('tbody')) {
        tbl.style.display = (q && visibleRows === 0) ? 'none' : '';
      }
    });
  });
})();
</script>
{% endif %}
{% endblock %}
